### Основная идея проекта:

- В современном мире очень сложно найти квартиру для покупки, чаще всего мы используем такие сайты как: "Авито", "Дом.Клик' и другие, 
но порой хочется увидеть утром какие-то выгодные предложения у себя в ленте, к примеру, в телеграмме. Именно для этого я сделал этот проект :) 
Мне всегда хотелось, чтобы когда я захожу в телеграм был какой-то бот который отправлял циклично выгодные квартиры по нескольким причинам:
  - Все находится в твоем любимом мессенджере;
  - Сразу присылаются самые выгодные предложение;
  - Можно ставить эмодзи на те предложения, которые вам понравилось.
- Как по мне все это звучит прекрасно, но а теперь по проекту;
- Канал в котором будут находиться квартиры [тут](https://t.me/moscow_flats_bot) :)

### Основные технологии:

- Docker:
  - docker-compose; 
  - Superset,
  - Clickhouse,
  - Airflow.
- Python:
  - apache-airflow и другие компоненты;
  - beautifulsoup4;
  - clickhouse-driver;
  - hyper;
  - pandas;
  - telegram и другие компоненты;
  - emoji (без него никак);
- Git и основы командной строки.

Подробнее о версиях и компонентах библиотек можно почитать в файлике requirements.txt :) 

### Ход проекта:

Изначальные требования:
- Все что будет в инструкциях будет адаптировано только под debian машинки;
- В идеале если вы владеете технологиями, которые я прописал выше.

1. Для начала давайте проверим что у вас есть гит и докер для этого выполните следующее:
   - Для докера:
     ```docker ps```
   - Для гита:
     ```git --version```
   Если все оки, то продолжайте следовать мануалу, если вылезла какая-то ошибка, то вы можете погуглить что за ошибка или попробовать
   заново установить гит и docker: 
      - [Дока по докеру](https://docs.docker.com/engine/install/ubuntu/);
      - [Статья по установке докера](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-20-04-ru);
      - [Статья по установке гита](https://www.digitalocean.com/community/tutorials/how-to-install-git-on-ubuntu-20-04).

2. Далее давайте развернем Superset и Clickhouse:
   1. Для начала давайте создадим volume, в котором будет хранится наша информация о квартирах, это можно сделать следующей командой:
      - ```docker volume create your_volume_name```
   2. После создаем сеть для Superset и Clickhouse, тем самым обособленные контейнеры смогут видеть друг друга, подробнее про это
      [тут](https://www.youtube.com/watch?v=bKFMS5C4CG0), также чтобы выполнить это нужно ввести эту команду:
      - ```docker network create your_network_name```
   3. После давайте поднимем наш контейнер с Superset, подробнее о том как поднять Superset можно почитать 
      [тут](https://hub.docker.com/r/apache/superset), а для того чтобы поднять стоит выполнить эту команду:
      - ```docker run -d --net=your_network_name -p your_pc_port:8088 --name superset apache/superset```
   Немного пояснений:
      - ```--net=your_network_name``` -- имя сети, в которой будет находится наш контейнер(superset);
      - ```-p your_pc_port:8088``` -- слева порт на вашем хосте, справа порт в контейнере;
      - ```--name superset``` -- устанавливаем имя для контейнера, чтобы docker это не сделал за нас;
      - И в конце прописываем образ.
   4. Далее давайте установим суперпользователя в нашем superset, делается это с помощью следующей команды:
      ``` 
        docker exec -it superset superset fab create-admin \
              --username your_username \
              --firstname Superset \ 
              --lastname Admin \ 
              --email admin@superset.com  \
              --password your_password \
      ```
   5. После давайте накатим миграции и инициализируем суперпользователя, сделать это можно используя следующие команды:
      - ```docker exec -it superset superset db upgrade```;
      - ```docker exec -it superset superset init```.
   6. С superset временно закончили, теперь давайте развернем базу данных, в нашем случае clickhouse, для этого 
      выполните следующею команду:
      - ```
        docker run -d\
        --name clickhouse\
        --net=your_network_name\
         -v your_volume_name:/var/lib/clickhouse\
         -p your_pc_port:9000\
          yandex/clickhouse-server
        ```
      Немного пояснений:
      - ```-v your_volume_name:/var/lib/clickhouse``` -- слева имя вашего заранее созданного вольюма, справа директория
      в контейнере, которая будет трекаться вашим вольюмом.
   7. Последним этапом остается подключить  Clickhouse к Superset и для этого нужно сходить в документацию и увидеть что 
      по дефолту мы не можем сделать этого, но нам может помочь библиотека, подробнее 
      [тут](https://superset.apache.org/docs/databases/clickhouse/). Устанавливаем библиотеку, используя эту команду:
      - ```docker exec superset pip install clickhouse-sqlalchemy```;
   8. Если в ходе моего гайда у вас возникли какие-либо ошибки, то можете смело глянуть вот этот [видос](https://www.youtube.com/watch?v=I1h2YaWW9PE&t=1s).

3. Далее вам понадобиться скопировать репозиторий с моим кодом, кастомным airflow и с файликом, где будут прописаны все зависимости.
   Для этого воспользуйтесь командой  ```git clone link_to_repository```.
4. Теперь нам нужно построить образ нашей кастомной airflow, для этого нужно воспользоваться следующей командой:
   - ```docker build . --tag your_custom_airflow:latest```. 
   Подробнее про docker build можно почитать [тут](https://docs.docker.com/engine/reference/commandline/build/).
5. Airflow состоит из нескольких сервисов и чтобы развернуть сразу нескольких контейнеров, которые уже будут иметь общею сеть 
   и будут взаимодействовать друг с другом нам понадобиться установить docker-compose, как это сделать:
   - [Дока по установке docker-compose](https://docs.docker.com/compose/install/);
   - [Статья по установке docker-compose](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-compose-on-ubuntu-20-04).
6. После установки нам стоит скачать yaml файлик airflow, небольшой гайд по его установке можно найти [тут](https://airflow.apache.org/docs/apache-airflow/2.5.1/docker-compose.yaml);
7. После того как вы успешно скачали файлик, создали нужные для 'распаковки' airflow директории следует поднять ваш сервис.
   Это можно сделать используя следующею команду:
   - ```docker-compose up```.
8. После того как вы сделали это вы можете убедиться что при поднятии задалась дефолтная сеть, так называемая airflow_default. При этом 
   мы помним что Clickhouse и Superset у нас лежат в другой сети, тогда давайте сконектим все контейнеры из сервиса airflow к нашей
   заранее созданной сети, для этого нам понадобиться следующая команда:
   - ```docker network connect your_network_name your_container_name``` -- подробнее про эту команду [тут](https://docs.docker.com/engine/reference/commandline/network_connect/). 
9. После этого вы можете обратить внимания что в моем скрипте есть переменные, которые будут видны только airflow и вам тоже их нужно
    заполнить, чтобы ваш скрипт был рабочим. Подробнее про каждый:
    - AIRFLOW_OWNER - имя юзера чей даг;
    - CLICKHOUSE_HOST - ip адрес Clickhouse;
    - TG_TOKEN_AVITO - токен бота;
    - CHAT_ID_MOSCOW_FLATS - id чата;
    - MAIL_TO_REPORT - email для репортинга.

После того как я выполнил все шаги, даг начнет работать успешно :)  

Также так как я любитель датавиза и в целом было бы интересно следить за обстановкой о ценах на квартирах в Москве я построил дашборд,
который выглядит вот так: 

![Dashboard](dashboard.jpg)

### Дополнительные материалы:

- Используемые материалы:
     1. Про Xcom в airflow: [Видео](https://www.youtube.com/watch?v=8veO7-SN5ZY);
     2. Про создание кастомного образа airflow: [Видео](https://www.youtube.com/watch?v=0UepvC9X4HY&t=165s);
     3. Про основы работы с superset: [Видео](https://www.youtube.com/watch?v=EW1dr9sdsyQ).

- Доп курсы:
     1. В ходе проекта я много пользовался таким инструментом как докер, так что очень советую посмотреть вот этот курс:
        - [Курс по докеру](https://karpov.courses/docker);
     2. Хоть мой код и неидеален также советую посмотреть вот этот курс по парсингу:
        - [Курс по парсингу](https://stepik.org/course/104774/info);
     3. Если вы захотите поискать что-то в ваших данных, то вы точно столкнетесь с SQL, так что советую вот этот курс:
        - [Курс по SQL](https://karpov.courses/simulator-sql).


